<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Service - Chiffrement S√©curis√©</title>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
            padding: 20px 0;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .tab-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .tab-btn:hover {
            background: rgba(255,255,255,0.4);
            transform: translateY(-2px);
        }

        .tab-btn.active {
            background: white;
            color: #667eea;
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 0.95em;
        }

        input[type="file"],
        input[type="password"],
        input[type="text"],
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
            font-family: inherit;
        }

        input[type="file"],
        input[type="password"],
        input[type="text"],
        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        button {
            flex: 1;
            min-width: 150px;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
            display: block;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #f5c6cb;
            display: block;
        }

        .alert.info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #bee5eb;
            display: block;
        }

        .result-box {
            background: #f8f9fa;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            font-size: 0.9em;
        }

        .result-box.active {
            display: block;
        }

        .file-drop {
            border: 3px dashed #667eea;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-drop:hover,
        .file-drop.dragover {
            background: #f0f0ff;
            border-color: #764ba2;
        }

        .file-drop p {
            color: #667eea;
            font-weight: 500;
        }

        .qr-container {
            text-align: center;
            margin-top: 20px;
        }

        #qrImage {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            margin-top: 10px;
        }

        .download-link {
            display: inline-block;
            margin-top: 15px;
            padding: 12px 24px;
            background: #4CAF50;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .download-link:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,0,0,0.1);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .card {
                padding: 20px;
            }

            button {
                min-width: 120px;
            }
        }
    </style>
</head>

<body>

<div class="container">
    <div class="header">
        <h1>üîê Crypto Service</h1>
        <p>Chiffrement s√©curis√© avec RSA, AES et Signature Num√©rique</p>
    </div>

    <!-- Onglets -->
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('aes', event)">üîí Chiffrement AES</button>
        <button class="tab-btn" onclick="switchTab('rsa', event)">üîë Chiffrement RSA</button>
        <button class="tab-btn" onclick="switchTab('signature', event)">‚úçÔ∏è Signature RSA</button>
        <button class="tab-btn" onclick="switchTab('qr', event)">üì± QR Code</button>
        <button class="tab-btn" onclick="switchTab('certs', event)">üßæ Certificats</button>
        <button class="tab-btn" onclick="switchTab('vault', event)">üîê Coffre-Fort</button>
    </div>

    <!-- TAB: AES -->
    <div id="aes" class="tab-content active">
        <div class="card">
            <h2>üîí Chiffrement AES-256</h2>
            <div id="alertAES" class="alert"></div>

            <div class="form-group">
                <label for="aesFile">Choisir un fichier √† chiffrer :</label>
                <div class="file-drop" id="aesDropZone">
                    <input type="file" id="aesFile" style="display: none;">
                    <p>üìÅ Glissez-d√©posez votre fichier ici<br>ou cliquez pour s√©lectionner</p>
                </div>
                <span id="aesFileName" style="margin-top: 10px; display: block; color: #667eea;"></span>
            </div>

            <div class="form-group">
                <label for="aesPassword">Mot de passe de chiffrement :</label>
                <input type="password" id="aesPassword" placeholder="Entrez un mot de passe s√©curis√©">
            </div>

            <div class="button-group">
                <button class="btn-primary" onclick="encryptAES()">Chiffrer le fichier</button>
                <button class="btn-secondary" onclick="resetAES()">R√©initialiser</button>
            </div>

            <div id="aesResult" class="result-box"></div>
            <div id="aesDownload"></div>
        </div>
    </div>

    <!-- TAB: RSA -->
    <div id="rsa" class="tab-content">
        <div class="card">
            <h2>üîë Chiffrement RSA-2048</h2>
            <div id="alertRSA" class="alert"></div>

            <div class="form-group">
                <label for="rsaFile">Choisir un fichier √† chiffrer :</label>
                <div class="file-drop" id="rsaDropZone">
                    <input type="file" id="rsaFile" style="display: none;">
                    <p>üìÅ Glissez-d√©posez votre fichier ici<br>ou cliquez pour s√©lectionner</p>
                </div>
                <span id="rsaFileName" style="margin-top: 10px; display: block; color: #667eea;"></span>
            </div>

            <div class="button-group">
                <button class="btn-primary" onclick="encryptRSA()">Chiffrer le fichier</button>
                <button class="btn-secondary" onclick="resetRSA()">R√©initialiser</button>
            </div>

            <div id="rsaResult" class="result-box"></div>
            <div id="rsaDownload"></div>
        </div>
    </div>

    <!-- TAB: SIGNATURE -->
    <div id="signature" class="tab-content">
        <div class="card">
            <h2>‚úçÔ∏è Signature Num√©rique RSA</h2>
            <div id="alertSignature" class="alert"></div>

            <div class="form-group">
                <label for="signFile">Choisir un fichier √† signer :</label>
                <div class="file-drop" id="signDropZone">
                    <input type="file" id="signFile" style="display: none;">
                    <p>üìÅ Glissez-d√©posez votre fichier ici<br>ou cliquez pour s√©lectionner</p>
                </div>
                <span id="signFileName" style="margin-top: 10px; display: block; color: #667eea;"></span>
            </div>

            <div class="button-group">
                <button class="btn-primary" onclick="signFile()">Signer le fichier</button>
                <button class="btn-secondary" onclick="resetSignature()">R√©initialiser</button>
            </div>

            <div id="signResult" class="result-box"></div>
            <div id="signDownload"></div>
        </div>
    </div>

    <!-- TAB: QR CODE -->
    <div id="qr" class="tab-content">
        <div class="card">
            <h2>üì± G√©n√©ration de QR Code</h2>
            <div id="alertQR" class="alert"></div>

            <div class="form-group">
                <label for="qrText">Texte √† encoder en QR Code :</label>
                <textarea id="qrText" placeholder="Entrez le texte ou data √† encoder" rows="5"></textarea>
            </div>

            <div class="button-group">
                <button class="btn-primary" onclick="generateQR()">G√©n√©rer QR Code</button>
                <button class="btn-primary" onclick="generateSignedQR()">QR Code Sign√©</button>
                <button class="btn-secondary" onclick="resetQR()">R√©initialiser</button>
            </div>

            <div class="qr-container">
                <img id="qrImage" src="" alt="QR Code" style="display: none;">
            </div>
        </div>
    </div>

    <!-- TAB: CERTIFICATS -->
    <div id="certs" class="tab-content">
        <div class="card">
            <h2>üßæ Gestion des Certificats</h2>
            <div id="alertCerts" class="alert"></div>

            <div class="form-group">
                <label for="certCN">Common Name (CN) :</label>
                <input type="text" id="certCN" placeholder="ex: example.local">
            </div>

            <div class="form-group">
                <label for="certOrg">Organization (optionnel) :</label>
                <input type="text" id="certOrg" placeholder="ex: MyOrg">
            </div>

            <div class="form-group">
                <label for="certDays">Validit√© (jours) :</label>
                <input type="text" id="certDays" placeholder="365">
            </div>

            <div class="form-group">
                <label for="certKeySize">Taille de la cl√© (bits) :</label>
                <input type="text" id="certKeySize" placeholder="2048">
            </div>

            <div class="button-group">
                <button class="btn-primary" onclick="generateCert()">G√©n√©rer certificat</button>
                <button class="btn-secondary" onclick="listCerts()">Rafra√Æchir la liste</button>
            </div>

            <div id="certResult" class="result-box"></div>

            <div class="card" style="margin-top:20px;">
                <h3 style="color:#667eea;">Certificats disponibles</h3>
                <div id="certList" style="margin-top:10px;"></div>
            </div>
        </div>
    </div>

    <!-- TAB: COFFRE-FORT -->
    <div id="vault" class="tab-content">
        <div class="card">
            <h2>üîê Coffre-Fort Num√©rique</h2>
            <p style="color: #999; margin-bottom: 20px;">Stockage s√©curis√© et chiffr√© de vos documents sensibles avec authentification</p>
            <div id="alertVault" class="alert"></div>

            <!-- Auth Section -->
            <div id="vaultAuthSection" style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="margin-top: 0; color: #667eea;">Authentification</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label style="font-size: 0.9em;">ID Utilisateur</label>
                        <input type="text" id="vaultUserId" placeholder="user123" style="padding: 8px; font-size: 0.9em;">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label style="font-size: 0.9em;">Mot de passe</label>
                        <input type="password" id="vaultPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="padding: 8px; font-size: 0.9em;">
                    </div>
                    <div style="display: flex; gap: 5px; align-items: flex-end;">
                        <button class="btn-primary" onclick="vaultRegister()" style="flex: 1; padding: 8px; font-size: 0.85em; margin-bottom: 0;">Cr√©er</button>
                        <button class="btn-primary" onclick="vaultLogin()" style="flex: 1; padding: 8px; font-size: 0.85em; margin-bottom: 0;">Connexion</button>
                    </div>
                </div>
            </div>

            <!-- Content Section (hidden until auth) -->
            <div id="vaultContentSection" style="display: none;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <!-- Upload Section -->
                    <div style="border-right: 1px solid #ddd; padding-right: 20px;">
                        <h3 style="color: #667eea; margin-bottom: 15px;">üì§ T√©l√©charger</h3>
                        
                        <div class="form-group">
                            <label for="vaultDocName">Nom du Document</label>
                            <input type="text" id="vaultDocName" placeholder="Ex: Contrat_2024">
                        </div>

                        <div class="form-group">
                            <label for="vaultFile">Fichier (optionnel)</label>
                            <input type="file" id="vaultFile">
                        </div>

                        <div class="form-group">
                            <label for="vaultData">Ou Contenu Texte</label>
                            <textarea id="vaultData" placeholder="Collez votre texte ici..." style="height: 100px; font-family: monospace;"></textarea>
                        </div>

                        <button class="btn-primary" onclick="vaultUpload()" style="width: 100%;">üíæ T√©l√©charger</button>
                    </div>

                    <!-- List Section -->
                    <div>
                        <h3 style="color: #667eea; margin-bottom: 15px;">üìã Mes Documents</h3>

                        <button class="btn-primary" onclick="vaultLoadDocs()" style="width: 100%; margin-bottom: 15px;">üîç Charger</button>

                        <div id="vaultDocsList" style="max-height: 350px; overflow-y: auto; border: 1px solid #ddd; border-radius: 6px; padding: 10px; background: #f9f9f9;">
                            <div style="text-align: center; color: #999; padding: 20px;">
                                Cliquez sur "Charger" pour voir vos documents
                            </div>
                        </div>

                        <!-- Audit Log Section -->
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                            <h4 style="color: #667eea; margin-bottom: 10px; font-size: 0.95em;">üìä Historique</h4>
                            <button class="btn-primary" onclick="vaultLoadAudit()" style="width: 100%; margin-bottom: 10px; padding: 8px; font-size: 0.9em;">Charger l'historique</button>
                            <div id="vaultAuditList" style="max-height: 150px; overflow-y: auto; border: 1px solid #ddd; border-radius: 6px; padding: 8px; background: #f5f5f5; font-size: 0.85em;">
                                <div style="text-align: center; color: #999; padding: 10px;">
                                    Cliquez sur "Charger l'historique"
                                </div>
                            </div>
                        </div>

                        <!-- Logout -->
                        <div style="margin-top: 10px; text-align: center;">
                            <button class="btn-secondary" onclick="vaultLogout()" style="padding: 8px 20px; font-size: 0.9em;">üö™ D√©connexion</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ======================== GESTION DES ONGLETS ========================
function switchTab(tabName, event) {
    // Masquer tous les onglets
    const tabContents = document.querySelectorAll('.tab-content');
    tabContents.forEach(tab => tab.classList.remove('active'));

    // D√©sactiver tous les boutons d'onglets
    const tabBtns = document.querySelectorAll('.tab-btn');
    tabBtns.forEach(btn => btn.classList.remove('active'));

    // Afficher l'onglet s√©lectionn√©
    document.getElementById(tabName).classList.add('active');
    if (event && event.target) {
        event.target.classList.add('active');
    }
    // Si on ouvre l'onglet certificats, rafra√Æchir la liste
    try {
        if (tabName === 'certs') {
            const list = document.getElementById('certList');
            if (list) list.innerHTML = 'Chargement des certificats...';
            listCerts();
        }
    } catch (e) {
        console.error('Erreur lors du switch vers certs:', e);
    }
}

// Handle hash navigation on page load
window.addEventListener('load', function() {
    if (window.location.hash) {
        const tabName = window.location.hash.substring(1);
        const tabBtn = Array.from(document.querySelectorAll('.tab-btn')).find(btn => {
            return btn.onclick && btn.onclick.toString().includes(`'${tabName}'`);
        });
        if (tabBtn) {
            switchTab(tabName, { target: tabBtn });
        }
    }
});

// ======================== UTILITAIRES ========================
function showAlert(elementId, message, type = 'info') {
    const alert = document.getElementById(elementId);
    alert.className = `alert ${type}`;
    alert.innerText = message;
}

function hideAlert(elementId) {
    const alert = document.getElementById(elementId);
    alert.className = 'alert';
    alert.innerText = '';
}

function showLoading(elementId) {
    const elem = document.getElementById(elementId);
    elem.innerHTML = '<div class="status"><div class="spinner"></div> Traitement en cours...</div>';
    elem.classList.add('active');
}

// Drag and drop pour fichiers
function setupFileDrop(dropZoneId, fileInputId, fileNameId) {
    const dropZone = document.getElementById(dropZoneId);
    const fileInput = document.getElementById(fileInputId);
    const fileName = document.getElementById(fileNameId);

    // Click to upload
    dropZone.addEventListener('click', () => fileInput.click());

    // File input change
    fileInput.addEventListener('change', (e) => {
        if (e.target.files[0]) {
            fileName.innerText = `‚úÖ Fichier s√©lectionn√©: ${e.target.files[0].name}`;
        }
    });

    // Drag and drop
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        if (e.dataTransfer.files[0]) {
            fileInput.files = e.dataTransfer.files;
            fileName.innerText = `‚úÖ Fichier s√©lectionn√©: ${e.dataTransfer.files[0].name}`;
        }
    });
}

// Initialiser drag and drop
setupFileDrop('aesDropZone', 'aesFile', 'aesFileName');
setupFileDrop('rsaDropZone', 'rsaFile', 'rsaFileName');
setupFileDrop('signDropZone', 'signFile', 'signFileName');

// ======================== AES ENCRYPTION ========================
function encryptAES() {
    const file = document.getElementById("aesFile").files[0];
    const password = document.getElementById("aesPassword").value;

    hideAlert('alertAES');

    if (!file) {
        showAlert('alertAES', '‚ùå Veuillez s√©lectionner un fichier', 'error');
        return;
    }
    if (!password) {
        showAlert('alertAES', '‚ùå Veuillez entrer un mot de passe', 'error');
        return;
    }

    showLoading('aesResult');

    const fd = new FormData();
    fd.append("file", file);
    fd.append("password", password);

    fetch("/api/aes/encrypt", { method: "POST", body: fd })
        .then(r => r.json())
        .then(d => {
            if(d.error) {
                showAlert('alertAES', '‚ùå Erreur: ' + d.error, 'error');
                document.getElementById('aesResult').classList.remove('active');
            } else {
                showAlert('alertAES', '‚úÖ Chiffrement AES r√©ussi!', 'success');
                document.getElementById('aesResult').innerText = 
                    `üîê Fichier chiffr√©\n` +
                    `Nom: ${d.file}\n` +
                    `Algorithme: ${d.algorithm}\n\n` +
                    `Le fichier a √©t√© sauvegard√© sur le serveur.`;
                document.getElementById('aesResult').classList.add('active');

                document.getElementById('aesDownload').innerHTML = 
                    `<a href="${d.download}" class="download-link" download>‚¨áÔ∏è T√©l√©charger le fichier chiffr√©</a>`;
            }
        })
        .catch(err => {
            showAlert('alertAES', '‚ùå Erreur r√©seau: ' + err.message, 'error');
            document.getElementById('aesResult').classList.remove('active');
        });
}

function resetAES() {
    document.getElementById('aesFile').value = '';
    document.getElementById('aesPassword').value = '';
    document.getElementById('aesFileName').innerText = '';
    document.getElementById('aesResult').classList.remove('active');
    document.getElementById('aesDownload').innerHTML = '';
    hideAlert('alertAES');
}

// ======================== RSA ENCRYPTION ========================
function encryptRSA() {
    const file = document.getElementById("rsaFile").files[0];

    hideAlert('alertRSA');

    if (!file) {
        showAlert('alertRSA', '‚ùå Veuillez s√©lectionner un fichier', 'error');
        return;
    }

    // RSA a une limite de taille
    if (file.size > 200) {
        showAlert('alertRSA', '‚ö†Ô∏è Fichier trop volumineux pour RSA (max ~200 bytes). Utilisez AES √† la place.', 'error');
        return;
    }

    showLoading('rsaResult');

    const fd = new FormData();
    fd.append("file", file);

    fetch("/api/rsa/encrypt", { method: "POST", body: fd })
        .then(r => r.json())
        .then(d => {
            if(d.error) {
                showAlert('alertRSA', '‚ùå Erreur: ' + d.error, 'error');
                document.getElementById('rsaResult').classList.remove('active');
            } else {
                showAlert('alertRSA', '‚úÖ Chiffrement RSA r√©ussi!', 'success');
                document.getElementById('rsaResult').innerText = 
                    `üîë Fichier chiffr√© avec RSA-2048\n` +
                    `Nom: ${d.file}\n` +
                    `Algorithme: ${d.algorithm}\n\n` +
                    `Hash (hex): ${d.encrypted.substring(0, 100)}...`;
                document.getElementById('rsaResult').classList.add('active');

                document.getElementById('rsaDownload').innerHTML = 
                    `<a href="${d.download}" class="download-link" download>‚¨áÔ∏è T√©l√©charger le fichier chiffr√©</a>`;
            }
        })
        .catch(err => {
            showAlert('alertRSA', '‚ùå Erreur r√©seau: ' + err.message, 'error');
            document.getElementById('rsaResult').classList.remove('active');
        });
}

function resetRSA() {
    document.getElementById('rsaFile').value = '';
    document.getElementById('rsaFileName').innerText = '';
    document.getElementById('rsaResult').classList.remove('active');
    document.getElementById('rsaDownload').innerHTML = '';
    hideAlert('alertRSA');
}

// ======================== SIGNATURE ========================
function signFile() {
    const file = document.getElementById("signFile").files[0];

    hideAlert('alertSignature');

    if (!file) {
        showAlert('alertSignature', '‚ùå Veuillez s√©lectionner un fichier', 'error');
        return;
    }

    showLoading('signResult');

    const fd = new FormData();
    fd.append("file", file);

    fetch("/api/rsa/sign", { method: "POST", body: fd })
        .then(r => r.json())
        .then(d => {
            if(d.error) {
                showAlert('alertSignature', '‚ùå Erreur: ' + d.error, 'error');
                document.getElementById('signResult').classList.remove('active');
            } else {
                showAlert('alertSignature', '‚úÖ Signature cr√©√©e avec succ√®s!', 'success');
                document.getElementById('signResult').innerText = 
                    `‚úçÔ∏è Fichier sign√© num√©riquement\n` +
                    `Fichier: ${d.file}\n` +
                    `Signature (hex): ${d.signature.substring(0, 100)}...\n\n` +
                    `La signature a √©t√© g√©n√©r√©e avec votre cl√© priv√©e.`;
                document.getElementById('signResult').classList.add('active');

                document.getElementById('signDownload').innerHTML = 
                    `<a href="${d.download}" class="download-link" download>‚¨áÔ∏è T√©l√©charger la signature</a>`;
            }
        })
        .catch(err => {
            showAlert('alertSignature', '‚ùå Erreur r√©seau: ' + err.message, 'error');
            document.getElementById('signResult').classList.remove('active');
        });
}

function resetSignature() {
    document.getElementById('signFile').value = '';
    document.getElementById('signFileName').innerText = '';
    document.getElementById('signResult').classList.remove('active');
    document.getElementById('signDownload').innerHTML = '';
    hideAlert('alertSignature');
}

// ======================== QR CODE ========================
function generateQR() {
    const text = document.getElementById("qrText").value;

    hideAlert('alertQR');

    if (!text) {
        showAlert('alertQR', '‚ùå Veuillez entrer un texte', 'error');
        return;
    }

    document.getElementById('qrImage').style.display = 'block';
    document.getElementById('qrImage').src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg"%3E%3Crect fill="%23f0f0f0" width="200" height="200"/%3E%3C/svg%3E';

    const fd = new FormData();
    fd.append("text", text);

    fetch("/api/qr/simple", { method: "POST", body: fd })
        .then(r => r.blob())
        .then(blob => {
            const url = URL.createObjectURL(blob);
            document.getElementById('qrImage').src = url;
            showAlert('alertQR', '‚úÖ QR Code g√©n√©r√© avec succ√®s!', 'success');
        })
        .catch(err => {
            showAlert('alertQR', '‚ùå Erreur: ' + err.message, 'error');
            document.getElementById('qrImage').style.display = 'none';
        });
}

function generateSignedQR() {
    const text = document.getElementById("qrText").value;

    hideAlert('alertQR');

    if (!text) {
        showAlert('alertQR', '‚ùå Veuillez entrer un texte', 'error');
        return;
    }

    document.getElementById('qrImage').style.display = 'block';
    document.getElementById('qrImage').src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg"%3E%3Crect fill="%23f0f0f0" width="200" height="200"/%3E%3C/svg%3E';

    const fd = new FormData();
    fd.append("text", text);

    fetch("/api/qr/signed", { method: "POST", body: fd })
        .then(r => r.blob())
        .then(blob => {
            const url = URL.createObjectURL(blob);
            document.getElementById('qrImage').src = url;
            showAlert('alertQR', '‚úÖ QR Code sign√© g√©n√©r√© avec succ√®s!', 'success');
        })
        .catch(err => {
            showAlert('alertQR', '‚ùå Erreur: ' + err.message, 'error');
            document.getElementById('qrImage').style.display = 'none';
        });
}

function resetQR() {
    document.getElementById('qrText').value = '';
    document.getElementById('qrImage').style.display = 'none';
    document.getElementById('qrImage').src = '';
    hideAlert('alertQR');
}

// ======================== CERTIFICATS ========================
function generateCert() {
    const cn = document.getElementById('certCN').value.trim();
    const org = document.getElementById('certOrg').value.trim();
    const days = document.getElementById('certDays').value.trim();
    const keySize = document.getElementById('certKeySize').value.trim();

    hideAlert('alertCerts');

    if (!cn) {
        showAlert('alertCerts', '[ERROR] Le Common Name (CN) est requis', 'error');
        return;
    }

    const fd = new FormData();
    fd.append('cn', cn);
    if (org) fd.append('organization', org);
    if (days) fd.append('days', days);
    if (keySize) fd.append('key_size', keySize);

    document.getElementById('certResult').classList.add('active');
    document.getElementById('certResult').innerText = 'Generation en cours...';

    fetch('/api/certs/generate', { method: 'POST', body: fd })
        .then(r => r.json())
        .then(d => {
            if (d.error) {
                showAlert('alertCerts', '[ERROR] Erreur: ' + d.error, 'error');
                document.getElementById('certResult').classList.remove('active');
                return;
            }

            showAlert('alertCerts', '[OK] Certificat genere avec succes', 'success');
            document.getElementById('certResult').innerText = `Certificat: ${d.cert}\nCle privee: ${d.key}`;

            // Afficher liens de telechargement
            const list = document.getElementById('certList');
            const itemHtml = `<div style="margin-top:8px;">
                <strong>${d.cert}</strong> &nbsp; <a class="download-link" href="${d.download_cert}">[DL] Certificat</a>
                &nbsp; <a class="download-link" href="${d.download_key}">[DL] Cle privee</a>
            </div>`;
            list.insertAdjacentHTML('afterbegin', itemHtml);
        })
        .catch(err => {
            showAlert('alertCerts', '[ERROR] Erreur reseau: ' + err.message, 'error');
            document.getElementById('certResult').classList.remove('active');
        });
}

function listCerts() {
    hideAlert('alertCerts');
    fetch('/api/certs/list')
        .then(r => r.json())
        .then(d => {
            if (d.error) {
                showAlert('alertCerts', '[ERROR] Erreur: ' + d.error, 'error');
                return;
            }

            const list = document.getElementById('certList');
            list.innerHTML = '';
            if (!d.files || d.files.length === 0) {
                list.innerHTML = '<div>Aucun certificat trouve.</div>';
                return;
            }

            d.files.forEach(f => {
                const url = `/download/keys/${encodeURIComponent(f)}`;
                const el = `<div style="margin-top:8px;"><strong>${f}</strong> &nbsp; <a class="download-link" href="${url}">[DL] Telecharger</a></div>`;
                list.insertAdjacentHTML('beforeend', el);
            })
        })
        .catch(err => showAlert('alertCerts', '[ERROR] Erreur reseau: ' + err.message, 'error'));
}

// Charger la liste au d√©marrage
document.addEventListener('DOMContentLoaded', () => {
    try { listCerts(); } catch (e) { /* ignore */ }
});

// ======================== COFFRE-FORT SESSION STORAGE ========================
let vaultSession = {
    userId: null,
    password: null
};

// ======================== COFFRE-FORT AUTH FUNCTIONS ========================
function vaultRegister() {
    const userId = document.getElementById('vaultUserId').value.trim();
    const password = document.getElementById('vaultPassword').value.trim();

    if (!userId || !password) {
        showAlert('alertVault', 'Veuillez entrer un ID et un mot de passe', 'error');
        return;
    }

    const formData = new FormData();
    formData.append('user_id', userId);
    formData.append('password', password);

    fetch('/api/vault/register', { method: 'POST', body: formData })
        .then(r => r.json())
        .then(d => {
            if (d.success) {
                showAlert('alertVault', 'Compte cr√©√©! Vous √™tes connect√©.', 'success');
                vaultSession.userId = userId;
                vaultSession.password = password;
                document.getElementById('vaultAuthSection').style.display = 'none';
                document.getElementById('vaultContentSection').style.display = 'block';
            } else {
                showAlert('alertVault', d.message || 'Erreur lors de la cr√©ation', 'error');
            }
        })
        .catch(err => showAlert('alertVault', 'Erreur: ' + err.message, 'error'));
}

function vaultLogin() {
    const userId = document.getElementById('vaultUserId').value.trim();
    const password = document.getElementById('vaultPassword').value.trim();

    if (!userId || !password) {
        showAlert('alertVault', 'Veuillez entrer un ID et un mot de passe', 'error');
        return;
    }

    const formData = new FormData();
    formData.append('user_id', userId);
    formData.append('password', password);

    fetch('/api/vault/login', { method: 'POST', body: formData })
        .then(r => r.json())
        .then(d => {
            if (d.success) {
                showAlert('alertVault', 'Bienvenue ' + userId + '!', 'success');
                vaultSession.userId = userId;
                vaultSession.password = password;
                document.getElementById('vaultAuthSection').style.display = 'none';
                document.getElementById('vaultContentSection').style.display = 'block';
            } else {
                showAlert('alertVault', d.message || 'Authentification √©chou√©e', 'error');
            }
        })
        .catch(err => showAlert('alertVault', 'Erreur: ' + err.message, 'error'));
}

function vaultLogout() {
    vaultSession.userId = null;
    vaultSession.password = null;
    document.getElementById('vaultAuthSection').style.display = 'block';
    document.getElementById('vaultContentSection').style.display = 'none';
    document.getElementById('vaultUserId').value = '';
    document.getElementById('vaultPassword').value = '';
    document.getElementById('vaultDocName').value = '';
    document.getElementById('vaultFile').value = '';
    document.getElementById('vaultData').value = '';
    document.getElementById('vaultDocsList').innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">Cliquez sur "Charger" pour voir vos documents</div>';
    showAlert('alertVault', 'D√©connect√©', 'info');
}

// ======================== COFFRE-FORT FUNCTIONS ========================
function vaultUpload() {
    if (!vaultSession.userId) {
        showAlert('alertVault', 'Veuillez d\'abord vous authentifier', 'error');
        return;
    }

    const docName = document.getElementById('vaultDocName').value.trim();
    const fileInput = document.getElementById('vaultFile');
    const docData = document.getElementById('vaultData').value.trim();

    if (!docName) {
        showAlert('alertVault', 'Veuillez entrer un nom de document', 'error');
        return;
    }

    if (fileInput.files.length === 0 && !docData) {
        showAlert('alertVault', 'Veuillez s√©lectionner un fichier ou ajouter du texte', 'error');
        return;
    }

    const formData = new FormData();
    formData.append('user_id', vaultSession.userId);
    formData.append('password', vaultSession.password);
    formData.append('doc_name', docName);
    
    if (fileInput.files.length > 0) {
        formData.append('file', fileInput.files[0]);
    } else if (docData) {
        formData.append('doc_data', docData);
    }

    fetch('/api/vault/store', { method: 'POST', body: formData })
        .then(r => r.json())
        .then(d => {
            if (d.error) {
                showAlert('alertVault', 'Erreur: ' + d.error, 'error');
                return;
            }
            showAlert('alertVault', 'Document t√©l√©charg√©! ID: ' + d.doc_id, 'success');
            document.getElementById('vaultDocName').value = '';
            document.getElementById('vaultFile').value = '';
            document.getElementById('vaultData').value = '';
            setTimeout(vaultLoadDocs, 800);
        })
        .catch(err => showAlert('alertVault', 'Erreur: ' + err.message, 'error'));
}

function vaultLoadDocs() {
    if (!vaultSession.userId) {
        showAlert('alertVault', 'Veuillez d\'abord vous authentifier', 'error');
        return;
    }

    const container = document.getElementById('vaultDocsList');
    container.innerHTML = '<div style="text-align: center;">Chargement...</div>';

    fetch(`/api/vault/list/${vaultSession.userId}/${encodeURIComponent(vaultSession.password)}`)
        .then(r => {
            if (r.status === 401) {
                showAlert('alertVault', 'Authentification √©chou√©e', 'error');
                vaultLogout();
                throw new Error('Auth failed');
            }
            return r.json();
        })
        .then(documents => {
            if (!Array.isArray(documents) || documents.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">Aucun document</div>';
                showAlert('alertVault', 'Aucun document trouv√©', 'info');
                return;
            }

            let html = '';
            documents.forEach(doc => {
                html += `
                    <div style="background: #f5f5f5; padding: 10px; margin: 8px 0; border-radius: 4px; border-left: 3px solid #667eea;">
                        <div style="font-weight: bold; margin-bottom: 5px;">üìÑ ${doc.doc_name}</div>
                        <div style="font-size: 0.9em; color: #666; margin-bottom: 8px;">
                            ${doc.doc_type} | ${doc.created_at}
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button class="vault-app-dl-btn btn-secondary" data-doc-id="${doc.doc_id}" data-doc-name="${doc.doc_name}" style="padding: 4px 10px; font-size: 0.85em;">üì• DL</button>
                            <button class="vault-app-del-btn btn-secondary" data-doc-id="${doc.doc_id}" style="padding: 4px 10px; font-size: 0.85em; background: #e74c3c;">üóëÔ∏è DEL</button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
            
            // Add event listeners to buttons
            document.querySelectorAll('.vault-app-dl-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const docId = this.getAttribute('data-doc-id');
                    const docName = this.getAttribute('data-doc-name');
                    vaultDownload(docId, docName);
                });
            });
            
            document.querySelectorAll('.vault-app-del-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const docId = this.getAttribute('data-doc-id');
                    vaultDelete(docId);
                });
            });
            
            showAlert('alertVault', documents.length + ' document(s) trouv√©(s)', 'success');
        })
        .catch(err => {
            if (err.message !== 'Auth failed') {
                container.innerHTML = '<div style="text-align: center; color: red; padding: 20px;">Erreur: ' + err.message + '</div>';
                showAlert('alertVault', 'Erreur: ' + err.message, 'error');
            }
        });
}

function vaultDownload(docId, docName) {
    if (!vaultSession.userId) return;
    
    const link = document.createElement('a');
    link.href = `/api/vault/retrieve/${vaultSession.userId}/${encodeURIComponent(vaultSession.password)}/${docId}`;
    link.download = docName || 'document';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function vaultDelete(docId) {
    if (!vaultSession.userId) return;
    
    if (!confirm('Supprimer ce document ?')) return;

    fetch(`/api/vault/delete/${vaultSession.userId}/${encodeURIComponent(vaultSession.password)}/${docId}`, { method: 'DELETE' })
        .then(r => r.json())
        .then(d => {
            if (d.success) {
                showAlert('alertVault', 'Document supprim√©', 'success');
                vaultLoadDocs();
            } else {
                showAlert('alertVault', 'Erreur: ' + d.error, 'error');
            }
        })
        .catch(err => showAlert('alertVault', 'Erreur: ' + err.message, 'error'));
}

function vaultLoadAudit() {
    if (!vaultSession.userId) {
        showAlert('alertVault', 'Veuillez d\'abord vous authentifier', 'error');
        return;
    }

    const container = document.getElementById('vaultAuditList');
    container.innerHTML = '<div style="text-align: center;">Chargement...</div>';

    fetch(`/api/vault/audit/${vaultSession.userId}/${encodeURIComponent(vaultSession.password)}`)
        .then(r => {
            if (r.status === 401) {
                showAlert('alertVault', 'Authentification √©chou√©e', 'error');
                vaultLogout();
                throw new Error('Auth failed');
            }
            return r.json();
        })
        .then(logs => {
            if (!Array.isArray(logs) || logs.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #999; padding: 10px;">Aucune action</div>';
                return;
            }

            let html = '';
            logs.slice(0, 20).forEach(log => {
                const timestamp = new Date(log.timestamp).toLocaleString('fr-FR');
                const statusColor = log.status === 'success' ? '#4CAF50' : '#f44336';
                html += `
                    <div style="padding: 8px; margin: 5px 0; background: #f5f5f5; border-radius: 3px; border-left: 3px solid ${statusColor}; font-size: 0.8em;">
                        <strong>${log.action}</strong> - ${log.doc_name || 'N/A'}<br>
                        <span style="color: #666;">${timestamp}</span>
                    </div>
                `;
            });

            container.innerHTML = html;
        })
        .catch(err => {
            if (err.message !== 'Auth failed') {
                container.innerHTML = '<div style="text-align: center; color: red; padding: 10px;">Erreur</div>';
            }
        });
}
</script>

</body>
</html>
